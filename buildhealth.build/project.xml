<project>

	<property name="project" value="MISSING_NAME" />
	<property name="project.deps" value="" />
	<property name="version" value="devel" />

	<script language="javascript">
		<![CDATA[ 
	        importClass(java.util.Locale);
	        actualDefault = Locale.getDefault();
	        project.setProperty("---actual-default-locale---", actualDefault);
	        Locale.setDefault(Locale.US);
	    ]]>
	</script>

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${basedir}/../buildhealth.build/lib/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<property name="project.dir" value="${basedir}" />
	<property name="src.dir" value="${project.dir}/src" />
	<property name="tests.dir" value="${project.dir}/tests" />
	<property name="lib.dir" location="${project.dir}/lib" />
	<property name="build.dir" value="${project.dir}/build" />
	<property name="build.tmp.dir" value="${build.dir}/tmp" />
	<property name="build.bin.dir" location="${build.tmp.dir}/bin" />
	<property name="build.javac.dir" location="${build.bin.dir}/src" />
	<property name="build.ejdt.dir" location="${build.bin.dir}/ejdt" />
	<property name="build.tests.dir" location="${build.bin.dir}/tests" />
	<property name="reports.dir" value="${build.dir}/reports" />
	<property name="reports.junit.dir" value="${reports.dir}/junit" />
	<property name="dist.dir" value="${build.dir}/dist" />

	<if>
		<equals arg1="${project.deps}" arg2="" />
		<then>
			<path id="project.deps.path">
			</path>
		</then>
		<else>
			<filelist id="project.deps.dirs" dir=".." files="${project.deps}" />

			<pathconvert refid="project.deps.dirs" property="project.deps.prop">
				<regexpmapper from="(.*)" to="\1/build/dist" />
			</pathconvert>

			<path id="project.deps.path">
				<fileset dir="${project.deps.prop}">
					<include name="**/*.jar" />
					<exclude name="**/*-source.jar" />
				</fileset>
			</path>
		</else>
	</if>

	<path id="libs.path">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
			<exclude name="**/*-source.jar" />
		</fileset>
	</path>
	<path id="compile.path">
		<path refid="project.deps.path" />
		<path refid="libs.path" />
	</path>

	<target name="all" depends="init, clean, compile, test, pack, clean-tmp" description="Compile, test and pack">
	</target>

	<target name="init">
		<tstamp />
	</target>

	<target name="clean" depends="init" description="Delete all build results">
		<delete dir="${build.dir}" quiet="true" />
	</target>

	<target name="clean-tmp" depends="init">
		<delete dir="${build.tmp.dir}" quiet="true" />
	</target>

	<target name="compile" depends="init" description="Compile the sources">
		<delete dir="${build.javac.dir}" quiet="true" />
		<mkdir dir="${build.javac.dir}" />

		<javac destdir="${build.javac.dir}" includeantruntime="false">
			<src path="${src.dir}" />
			<classpath refid="compile.path" />
		</javac>
	</target>

	<target name="compile-tests" depends="compile">
		<delete dir="${build.tests.dir}" quiet="true" />
		<mkdir dir="${build.tests.dir}" />

		<javac destdir="${build.tests.dir}" debug="true" includeantruntime="false">
			<src path="${tests.dir}" />
			<classpath refid="compile.path" />
			<classpath>
				<pathelement location="${build.javac.dir}" />
			</classpath>
		</javac>

		<copy todir="${build.tests.dir}">
			<fileset dir="${tests.dir}" excludes="**/*.java" />
		</copy>
	</target>

	<target name="test" depends="compile-tests" description="Run the tests">
		<delete dir="${reports.junit.dir}" quiet="true" />
		<mkdir dir="${reports.junit.dir}" />

		<junit printsummary="yes" fork="yes">
			<classpath refid="compile.path" />
			<classpath>
				<pathelement location="${build.javac.dir}" />
				<pathelement location="${build.tests.dir}" />
			</classpath>

			<formatter type="xml" />

			<batchtest todir="${reports.junit.dir}">
				<fileset dir="${tests.dir}">
					<include name="**/*Test.java" />
					<exclude name="**/Base*Test.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>

	<target name="pack" description="Create jar archives">
		<delete dir="${dist.dir}" quiet="true" />
		<mkdir dir="${dist.dir}" />

		<jar jarfile="${dist.dir}/${project}-${version}.jar" basedir="${build.javac.dir}" />
		<jar jarfile="${dist.dir}/${project}-${version}-source.jar" basedir="${src.dir}" />
	</target>

</project>